USE DBMedico;


-------- TRIGGER IRA DISPARAR A INSERÇÃO DE DADOS APOS A ATUALIZAÇÃO DE DADOS NA TABELA PRINCIPAL CHAMADA PACIENTES, POIS ISSO É PARA REGISTRAR UM HISTORICO. 

CREATE TRIGGER TGR_INSERE_DADOS_PAC_HIS
ON PACIENTES
FOR UPDATE

AS
BEGIN
	DECLARE @CPF  VARCHAR(15),
	        @ENDERECO  VARCHAR(100),
			@CEP VARCHAR(10),
			@UPDATE_DATE DATE = GETDATE(),
			@ID_PAC INT,
			@ID_MEDI INT,
			@TEVE_ALTA BIT = '1',
			@INSERT_DATETIME DATE = GETDATE()

	SELECT @CPF = CPF_PAC, @ENDERECO = END_PAC, @CEP = CEP_PAC, @ID_PAC = ID_PACIENTE, @ID_MEDI = ID_MEDICO FROM INSERTED

	UPDATE PACIENTES
			SET END_PAC = @ENDERECO,
			UPDATE_DATETIME = @UPDATE_DATE,
			CEP_PAC = @CEP
	WHERE CPF_PAC = @CPF;

	INSERT INTO PACIENTE_ALTA (ID_PAC_HIS, ID_PACIENTE, ID_MEDICO, TEVE_ALTA, INSERT_DATE)
					VALUES  (NEXT VALUE FOR SEQ_PACIENTE_ALTA, @ID_PAC, @ID_MEDI, @TEVE_ALTA, @INSERT_DATETIME);

	END;


--------------- TRIGGER EXECUTADA COM SUCESSO APOS O UPDATE ABAIXO

UPDATE PACIENTES
SET END_PAC = 'Rua Guatemala, nº 2',
UPDATE_DATETIME = GETDATE(),
CEP_PAC = '08040-124'
WHERE CPF_PAC = '124522325565';


SELECT * FROM PACIENTES WHERE CPF_PAC IN ('124522325565');

SELECT * FROM PACIENTE_ALTA WHERE ID_PACIENTE = '3';

