----- Procedure para inserir registro na tabela caso não encontre o dado cadastrado

USE DBMedico;

------- Comando para dar um Drop na Procedure

DROP PROCEDURE PRC_VERIFICAR_MEDICO_EXISTE;

CREATE PROCEDURE PRC_VERIFICAR_MEDICO_EXISTE

		@CRM VARCHAR(12),
		@ID_DEP INT,
		@NOME VARCHAR(30),
		@ESPECIALIDADE VARCHAR(30),
		@DATA_VENC_CRM DATE

AS
	SET NOCOUNT ON;

	IF @CRM = (SELECT CRM FROM DOUTORES WHERE CRM = @CRM)
	
	SELECT CRM, NOME_MEDICO, ESPECIALIDADE, DATA_VENC_CRM FROM DOUTORES WHERE CRM = @CRM

	ELSE
		
		INSERT INTO DOUTORES (CRM, ID_DEPARTAMENTO, NOME_MEDICO, ESPECIALIDADE, DATA_VENC_CRM, INSERT_DATETIME)
					   VALUES(@CRM, @ID_DEP, @NOME, @ESPECIALIDADE, @DATA_VENC_CRM, GETDATE())
	
	PRINT 'Medico não tinha cadastro, dessa forma foi realizado o cadastro com sucesso'


----------------------------------------------------------------------------------------

------ FAZENDO UM TESTE EM BASE DE DADOS COM O CADASTRO JA EXISTENTE E FUNCIONOU NORMALMENTE
EXEC PRC_VERIFICAR_MEDICO_EXISTE @CRM = '084560-SP', @ID_DEP = 5, @NOME = 'Claudia Silva de Souza', @ESPECIALIDADE = 'Clinico Geral', @DATA_VENC_CRM = '2025-08-23'


----- VERIFICANDO OS DADOS QUE NÃO EXISTE NO SISTEMA E REALIZADO O CADASTRO AUTOMATICO PELO INSERT DA PROCEDURE
EXEC PRC_VERIFICAR_MEDICO_EXISTE @CRM = '040123-ES', @ID_DEP = 5, @NOME = 'Jose Pinto da Fonseca', @ESPECIALIDADE = 'Ginecologista', @DATA_VENC_CRM = '2024-06-30';


------ NOTA-SE QUE A PROCEDURE CADASTROU NORMALMENTE DEVIDO NÃO TER NENHUM DADO CADASTRADO ANTES
SELECT * FROM DOUTORES WHERE CRM = '040123-ES';

----- SE RODAR O ULTIMO EXEC DA PROCEDURE ELE TRARÁ O DADO DO JOSE CADASTRADO
